> é€šå‘è£èª‰çš„è·¯ä¸Šï¼Œå¹¶ä¸é“ºæ»¡é²œèŠ±ã€‚

## å‰è¨€
ç”¨Javaçˆ¬åˆ°æˆ‘æˆ¿é—´ç”µè¡¨ç”µé‡ä½¿ç”¨æƒ…å†µåï¼Œå°è£…äº†ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå®¢æˆ·ç«¯çš„è°ƒç”¨ğŸ˜
åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ç”¨Macçš„æ—¶é—´æ˜¯æœ€å¤šçš„ï¼Œå¦‚æœå°†çˆ¬åˆ°çš„æ•°æ®ï¼Œå±•ç¤ºåœ¨Macçš„é¡¶æ ä¸Šï¼Œæ˜¯ä¸€ä»¶å¾ˆç¾å¥½çš„äº‹æƒ…ğŸ˜Œ
ä½œä¸ºä¸€ä¸ªå¯¹Swiftä¸€æ— æ‰€çŸ¥çš„æˆ‘ï¼ŒèŠ±äº†ä¸¤å¤©æ—¶é—´ï¼Œç”¨Swiftè¯­è¨€å¼€å‘äº†ä¸€ä¸ªMacåº”ç”¨ï¼Œæ¥ä¸‹æ¥å°±è·Ÿå¤§å®¶åˆ†äº«ä¸‹è¿™ä¸ªåº”ç”¨çš„å¼€å‘è¿‡ç¨‹ï¼Œæ¬¢è¿å„ä¸ºæ„Ÿå…´è¶£çš„å¼€å‘è€…é˜…è¯»æœ¬æ–‡ã€‚

å…ˆè·Ÿå¤§å®¶çœ‹ä¸‹æœ€ç»ˆå®ç°çš„æ•ˆæœ:
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d937efe4d12c?w=1019&h=381&f=png&s=630185)

## ç¯å¢ƒæ­å»º
> Swift: 4.2.1

> Xcode: 10.1

> MacOS: 10.14.2

> åº“ç®¡ç†å·¥å…·: Carthage

> Alamofire: 4.0 (ç½‘ç»œè¯·æ±‚åº“)

> SwiftyJSON: 3.0 (Jsonè§£æåº“)

### åˆ›å»ºé¡¹ç›®
* æ‰“å¼€Xcodeï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ç•Œé¢å¦‚å›¾æ‰€ç¤º
  * å·¦è¾¹ä¸ºåˆ›å»ºé¡¹ç›®éƒ¨åˆ†ï¼Œå³è¾¹ä¸ºæœ€è¿‘æ‰“å¼€çš„é¡¹ç›®
  * ç‚¹å‡»å›¾ä¸­ç”¨çº¢æ¬¾å‹¾é€‰çš„åœ°æ–¹
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d93bea637092?w=820&h=488&f=png&s=83879)
* å¦‚å›¾æ‰€ç¤ºï¼ŒæŒ‰å›¾ä¸­æ ‡æ˜çš„åºå·ï¼Œåˆ†åˆ«è¿›è¡Œç‚¹å‡»ã€‚
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d93e391d5c25?w=1425&h=984&f=png&s=545996)
* å¦‚å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«å¡«å†™é¡¹ç›®ç›¸å…³ä¿¡æ¯
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d943ea892330?w=748&h=544&f=png&s=53396)
* é€‰æ‹©é¡¹ç›®åˆ›å»ºä½ç½®
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d946256db929?w=817&h=466&f=png&s=67131)
* å‡ºç°å¦‚å›¾æ‰€ç¤ºçš„é¡µé¢åï¼Œé¡¹ç›®åˆ›å»ºæˆåŠŸ
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d948264eb0ea?w=1418&h=978&f=png&s=164623)

### é…ç½®é¡¹ç›®ä¸ºä¸€ä¸ªèœå•æ åº”ç”¨
æ­¤æ—¶é¡¹ç›®ä¸ºä¸€ä¸ªç©ºç™½é¡¹ç›®ï¼Œç‚¹è¿è¡Œåä¼šå‡ºç°ä¸€ä¸ªç©ºçš„windowçª—å£ï¼ŒåŒæ—¶dockä¸Šå‡ºç°åº”ç”¨å›¾æ ‡ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬è¦çš„ï¼Œæ‰€ä»¥è¦æ·»åŠ é…ç½®æ¥ç§»é™¤ä»–ä»¬ã€‚
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d94a6d10fc95?w=570&h=491&f=png&s=117973)

* å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨infoä¸‹æ·»åŠ æ·»åŠ ä¸€ä¸ªé…ç½®é¡¹
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d94c931fdaf5?w=1418&h=978&f=png&s=222737)
* Keyé€‰æ‹©**Application is agent (UI Element)**,Valueé€‰æ‹©Yes
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d95f847f77a6?w=687&h=312&f=png&s=58919)
* æ­¤æ—¶å†æ¬¡è¿è¡Œç¨‹åºï¼Œæˆ‘ä»¬å‘ç°dockæ å·²ç»ä¸æ˜¾ç¤ºç¨‹åºå›¾æ ‡ï¼Œä½†æ˜¯windowçª—å£ä¾ç„¶åœ¨
* æ ¹æ®å›¾ä¸­æ‰€ç¤ºï¼Œåˆ é™¤**Window Controller Scene**å’Œ**View Controller Scene**
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d96d16274b9e?w=1418&h=978&f=png&s=209777)
* æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨äº‘å¿ƒåº”ç”¨ç¨‹åºï¼Œå‘ç°çª—å£ä¹Ÿæ²¡äº†ã€‚

### åœ¨èœå•æ åˆ›å»ºå›¾æ ‡
* å¦‚å›¾æ‰€ç¤º,ç‚¹å‡»**Assets.xcassets**æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ª**Image Set**
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d973f2cc6551?w=1421&h=984&f=png&s=436690)
* å¦‚å›¾æ‰€ç¤ºï¼Œå°†å…¶å‘½åä¸º**StatusIcon**ï¼Œå°†è‡ªå·±ä¸­æ„çš„å›¾ç‰‡åˆ¶ä½œæˆ3ç§è§„æ ¼ï¼Œæ‰˜å…¥å¯¹åº”çš„ä½ç½®ã€‚
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d97ca9bea24f?w=881&h=320&f=png&s=46912)
* æ‹–å…¥å›¾æ ‡åï¼Œæ‰§è¡Œå›¾ç‰‡ä¸­çš„æ­¥éª¤ï¼Œè®©å›¾æ ‡é€‚é…ç³»ç»Ÿçš„é»‘æš—æ¨¡å¼
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d980e2d416ff?w=1140&h=787&f=png&s=105848)
* æ‰“å¼€AppDelegate.swiftæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç 
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9841bbdd090?w=792&h=410&f=png&s=66969)

```swift
    // åˆ›å»ºçŠ¶æ€æ æŒ‰é’®
    let statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)
```
```swift
    // applicationDidFinishLaunchingç”Ÿå‘½å‘¨æœŸ
    if let button = statusItem.button {
         button.image = NSImage(named: "StatusIcon")
    }
```
* è¿è¡Œç¨‹åºï¼Œæˆ‘ä»¬å‘ç°èœå•æ æœ‰äº†æˆ‘ä»¬åˆšæ‰è®¾ç½®çš„å›¾æ ‡ï¼Œæ­¤æ—¶ç‚¹å‡»åä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚

### æ·»åŠ **Popover**å®¹å™¨
* åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ª**Cocoa Class**ï¼Œå‘½åä¸º**PopoverViewController**,æ­¤æ–‡ä»¶ä¸ºç‚¹å‡»æ—¶æ‰“å¼€çš„å¼¹å±‚é¡µé¢
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9908d63a59a?w=542&h=542&f=png&s=440488)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9956953bf59?w=757&h=547&f=png&s=160021)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d997dda69e80?w=748&h=544&f=png&s=35952)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d99c199f709a?w=817&h=466&f=png&s=68053)
* æ·»åŠ View Controllerå®¹å™¨
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d99d68a0fa2d?w=1420&h=976&f=png&s=651738)
* å¦‚å›¾æ‰€ç¤ºï¼Œå¯¹ä¸Šä¸€æ­¥æ·»åŠ çš„å®¹å™¨è¿›è¡Œä¿®æ”¹
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d99efc1266fb?w=1651&h=629&f=png&s=97301)
* æ‰“å¼€PopoverViewController.swiftæ–‡ä»¶ï¼Œåœ¨æœ«å°¾æ·»åŠ å¦‚ä¸‹ä»£ç 

```swift
extension PopoverViewController {
    static func freshController() -> PopoverViewController {
        //è·å–å¯¹Main.storyboardçš„å¼•ç”¨
        let storyboard = NSStoryboard(name: NSStoryboard.Name("Main"), bundle: nil)
        // ä¸ºPopoverViewControlleråˆ›å»ºä¸€ä¸ªæ ‡è¯†ç¬¦
        let identifier = NSStoryboard.SceneIdentifier("PopoverViewController")
        // å®ä¾‹åŒ–PopoverViewControllerå¹¶è¿”å›
        guard let viewcontroller = storyboard.instantiateController(withIdentifier: identifier) as? PopoverViewController else {
            fatalError("Something Wrong with Main.storyboard")
        }
        return viewcontroller
    }
}

```
* æ‰“å¼€AppDelegate.swiftæ–‡ä»¶åœ¨classå†…æ·»åŠ å¦‚ä¸‹ä»£ç 
```swift
// å£°æ˜ä¸€ä¸ªPopover
let popover = NSPopover()
```

### åˆ›å»ºæ˜¾ç¤º/éšè—Popoverçš„å‡½æ•°
* åœ¨AppDelegate.swiftæ–‡ä»¶çš„classå†…æ·»åŠ å¦‚ä¸‹ä»£ç 
```swift
    // æ§åˆ¶PopoverçŠ¶æ€
    @objc func togglePopover(_ sender: AnyObject) {
        if popover.isShown {
            closePopover(sender)
        } else {
            showPopover(sender)
        }
    }
    // æ˜¾ç¤ºPopover
    @objc func showPopover(_ sender: AnyObject) {
        if let button = statusItem.button {
            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)
        }
        
    }
    // éšè—Popover
    @objc func closePopover(_ sender: AnyObject) {
        popover.performClose(sender)
    }
```
* åœ¨AppDelegate.swiftæ–‡ä»¶çš„**applicationDidFinishLaunching**å‡½æ•°ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç 
```swift
    if let button = statusItem.button {
            button.image = NSImage(named: "StatusIcon")
            button.action = #selector(togglePopover(_:))
    }
    popover.contentViewController =            PopoverViewController.freshController()
```
* æ­¤æ—¶ï¼Œè¿è¡Œé¡¹ç›®ï¼Œç‚¹å‡»èœå•æ çš„åº”ç”¨å›¾æ ‡ï¼Œä¼šæ˜¾ç¤ºå¼¹å±‚ï¼Œå†æ¬¡ç‚¹å‡»å¼¹å±‚ä¼šæ¶ˆå¤±
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9aa09843c8d?w=498&h=366&f=png&s=171398)

### ä¼˜åŒ–Popover
æ‰§è¡Œå®Œä¸Šä¸ªæ­¥éª¤åï¼Œæˆ‘ä»¬ä¼šå‘ç°å¼¹å±‚åªä¼šåœ¨ç‚¹å‡»æ—¶å…³é—­æˆ–è€…æ¶ˆå¤±ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¼˜åŒ–ä¸‹ï¼Œå¤±å»ç„¦ç‚¹æ—¶ï¼Œä¹Ÿè®©å®ƒéšè—
* æ–°å»ºä¸€ä¸ªEventMonitor.swiftæ–‡ä»¶ï¼Œç”¨äºäº‹ä»¶ç›‘å¬,æ­¤æ–‡ä»¶ä»£ç å¦‚ä¸‹
```swift
import Cocoa

public class EventMonitor {
    private var monitor: Any?
    private let mask: NSEvent.EventTypeMask
    private let handler: (NSEvent?) -> Void
    
    public init(mask: NSEvent.EventTypeMask, handler: @escaping (NSEvent?) -> Void) {
        self.mask = mask
        self.handler = handler
    }
    
    deinit {
        stop()
    }
    
    public func start() { //å¼€å¯ç›‘è§†å™¨
        monitor = NSEvent.addGlobalMonitorForEvents(matching: mask, handler: handler)
    }
    
    public func stop() { //å…³é—­ç›‘è§†å™¨
        if monitor != nil {
            NSEvent.removeMonitor(monitor!)
            monitor = nil
        }
    }
}

```
* æ‰“å¼€AppDelegate.swiftåœ¨classä¸­å£°æ˜è¿™ä¸ªç›‘è§†å™¨
```swift
// å£°æ˜ç›‘è§†å™¨
var eventMonitor: EventMonitor?
```
* åœ¨applicationDidFinishLaunchingå‡½æ•°ä¸­æ·»åŠ 
```swift
eventMonitor = EventMonitor(mask: [.leftMouseDown, .rightMouseDown]) { [weak self] event in
  if let strongSelf = self, strongSelf.popover.isShown {
    strongSelf.closePopover(event!)
  }
}
```
* ä¿®æ”¹showPopoverå’ŒclosePopoverå‡½æ•°
```swift
    // æ˜¾ç¤ºPopover
    @objc func showPopover(_ sender: AnyObject) {
        if let button = statusItem.button {
            popover.show(relativeTo: button.bounds, of: button, preferredEdge: NSRectEdge.minY)
        }
        eventMonitor?.start()
        
    }
    // éšè—Popover
    @objc func closePopover(_ sender: AnyObject) {
        popover.performClose(sender)
        eventMonitor?.stop()
    }
```
* è¿è¡Œé¡¹ç›®ï¼Œæˆ‘ä»¬å‘ç°å¤±å»ç„¦ç‚¹åï¼Œå¼¹å±‚éšè—æ‰äº†ã€‚

### æ·»åŠ å³é”®èœå•
* å¦‚å›¾æ‰€ç¤ºï¼Œæ·»åŠ menuç»„ä»¶è¿›æ¥
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9aed82349f3?w=1634&h=773&f=png&s=244591)
* å°† Menu ä¸ AppDelegate.swift å»ºç«‹è”ç³»
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9b21411809d?w=291&h=429&f=png&s=157270)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9b605a42b0f?w=1392&h=455&f=png&s=124322)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9bcdf877e65?w=330&h=189&f=png&s=25356)
* åˆ é™¤å¤šä½™é¡¹ï¼Œæ·»åŠ é€€å‡ºå›¾æ ‡å’Œæ¡ç›®
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9bf89b8d456?w=1321&h=708&f=png&s=202399)
* ä¿®æ”¹AppDelegate.swiftæ–‡ä»¶ï¼Œæ·»åŠ Handleræ¥æ¥ç®¡togglePopover
```swift
// æ¥ç®¡togglePopover
    @objc func mouseClickHandler() {
        if let event = NSApp.currentEvent {
            switch event.type {
            case .leftMouseUp:
                togglePopover(popover)
            default:
                statusItem.menu = Menu
                statusItem.button?.performClick(nil)
            }
        }
    }
```
* statusItem.buttonæ·»åŠ å¦‚ä¸‹ä»£ç 
```swift
// ç‚¹å‡»äº‹ä»¶
 button.action = #selector(mouseClickHandler)
 button.sendAction(on: [.leftMouseUp, .rightMouseUp])
```
* åœ¨AppDelegate.swiftçš„æœ«å°¾æ·»åŠ 
```swift
extension AppDelegate: NSMenuDelegate {
    // ä¸ºäº†ä¿è¯æŒ‰é’®çš„å•å‡»äº‹ä»¶è®¾ç½®æœ‰æ•ˆï¼Œmenuè¦å»é™¤
    func menuDidClose(_ menu: NSMenu) {
        self.statusItem.menu = nil
    }
}

```
* åœ¨applicationDidFinishLaunchingå†…æ·»åŠ 
```swift
// ä¿®å¤æŒ‰é’®å•å‡»äº‹ä»¶æ— æ•ˆé—®é¢˜
Menu.delegate = self
```
* æ­¤æ—¶å³é”®ï¼Œæˆ‘ä»¬å‘ç°å·²æˆåŠŸæ·»åŠ 
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9d0e4089b76?w=207&h=127&f=png&s=22485)

### å®ç°é€€å‡ºåŠŸèƒ½
* å¦‚å›¾æ‰€ç¤ºï¼Œå°†æ¨å‡ºå‡½æ•°å…³è”è‡³AppDelegateæ–‡ä»¶ä¸‹
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9d40bbde690?w=1606&h=647&f=png&s=337110)
* å®Œå–„é€€å‡ºappå‡½æ•°
```swift
    // å…³é—­App
    @IBAction func Quit(_ sender: Any) {
        NSApplication.shared.terminate(self)
    }
```
* å†æ¬¡è¿è¡Œåï¼Œå³é”®ï¼Œç‚¹å‡»æ¨å‡ºï¼Œå³å¯å…³é—­åº”ç”¨

## ç¼–å†™Popoveré¡µé¢
æ‰§è¡Œå®Œä¸Šè¿°æ­¥éª¤åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„Popover,æ¥ä¸‹æ¥æˆ‘ä»¬å¾€Popoveræ·»åŠ å†…å®¹ï¼Œè°ƒç”¨æ¥å£ï¼Œæ˜¾ç¤ºæˆ‘ä»¬æˆ¿é—´ç”µè¡¨ç”µé‡ä½¿ç”¨æƒ…å†µã€‚

### å¸ƒå±€é¡µé¢
* å¦‚å›¾æ‰€ç¤º,æ·»åŠ Text Fieldå’Œlabelç»„ä»¶ï¼Œæ‹–æ‹½è‡³PopoverViewControllerä¸­ï¼Œå¹¶ä¸PopoverViewController.swiftè¿›è¡Œå…³è”
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9d8f13ab865?w=685&h=768&f=png&s=316966)
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9dc577402b0?w=1645&h=556&f=png&s=275660)
* è°ƒæ•´æ‹–å‡ºæ¥çš„æ§ä»¶å¤§å°ï¼Œææˆå¦‚å›¾æ‰€ç¤ºçš„æ ·å­
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9dd9c3fc162?w=538&h=532&f=png&s=33339)

### å®‰è£…Cartfileåº“ç®¡ç†å·¥å…·
[Cartfile](https://github.com/Carthage/Carthage)æ˜¯ä¸€ä¸ªä¼˜ç§€çš„åº“ç®¡ç†å·¥å…·ï¼Œç›¸å½“äºæˆ‘ä»¬å‰ç«¯çš„npmã€‚

* ç‚¹å‡»[Cartfileä¸‹è½½åœ°å€](https://github.com/Carthage/Carthage/releases)ï¼Œè¿›å…¥Cartfileçš„githubä»“åº“çš„ä¸‹è½½é¡µé¢ï¼Œé€‰æ‹©pkgæ–‡ä»¶ä¸‹è½½ï¼Œç„¶åå®‰è£…ã€‚
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9e4896289dd?w=944&h=521&f=png&s=63778)

### å®‰è£…ç½‘ç»œè¯·æ±‚åº“å’ŒJsonè§£æåº“
> Alamofire,ä¸ºä¸€ä¸ªä¼˜ç§€çš„ç½‘ç»œè¯·æ±‚åº“ï¼Œä»–å°è£…äº†å„ç§httpè¯·æ±‚ã€‚

> SwiftyJSON,ä¸ºä¸€ä¸ªä¼˜ç§€çš„jsonè§£æåº“

æˆ‘ä»¬å¯ä»¥é€šè¿‡Cartfileæ¥è·å–ä»–ä»¬

* åœ¨æˆ‘ä»¬çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºCartfileæ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹
```bash
github "Alamofire/Alamofire" ~> 4.0
github "SwiftyJSON/SwiftyJSON" ~> 3.0
```
* æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥åˆ°æˆ‘ä»¬é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
```bash
carthage update --platform macOS
```
* æ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬å‘ç°ï¼Œé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹å¤šäº†Carthageæ–‡ä»¶å¤¹
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9e8d20e85dc?w=788&h=454&f=png&s=78244)
* æ­¤æ—¶æˆ‘ä»¬æ‰“å¼€ï¼Œxcodeï¼Œæ‰“å¼€å¦‚å›¾æ‰€ç¤ºçš„é¡µé¢
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9ebd63d0b2d?w=1418&h=978&f=png&s=190138)
* å¦‚å›¾æ‰€ç¤ºï¼Œé€‰æ‹©æˆ‘ä»¬åˆšæ‰Carthageæ–‡ä»¶å¤¹ä¸‹çš„ï¼Œbuild->Mac->frameworkæ–‡ä»¶
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9ed5588449d?w=822&h=317&f=png&s=166007)
* æ·»åŠ æˆåŠŸåï¼Œå¦‚å›¾æ‰€ç¤º
![](https://user-gold-cdn.xitu.io/2020/3/25/1710d9ee68e5e93c?w=1188&h=726&f=png&s=135965)

### å¼€å¯ç½‘ç»œè®¿é—®
Xcodeé»˜è®¤ä¸å…è®¸httpè¯·æ±‚ï¼ŒæŒ‰ç…§å¦‚å›¾æ‰€ç¤ºçš„æ“ä½œè¿›è¡Œå³å¯ã€‚
![](https://user-gold-cdn.xitu.io/2020/3/25/171122bca2dc187f?w=986&h=574&f=png&s=155646)

### è°ƒç”¨æ¥å£æ¸²æŸ“é¡µé¢
> åœ¨PopoverViewController.swiftæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç 
```swift
import Cocoa
import Alamofire
import SwiftyJSON

class PopoverViewController: NSViewController {
    // ä»Šæ—¥ç”¨ç”µ
    @IBOutlet weak var electricityToday: NSTextField!
    // æœ¬æœˆå·²ç”¨
    @IBOutlet weak var currentMonthBatteryTotal: NSTextField!
    // å‰©ä½™ç”µé‡
    @IBOutlet weak var remainingBattery: NSTextField!
    // ç»Ÿè®¡æ—¶é—´
    @IBOutlet weak var time: NSTextField!

    private var timer: Timer?
    // å®šæ—¶å™¨è®°æ•°: æ¯20åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œ3è½®ä¸º1å°æ—¶
    private var timeCount = 3
    
    override func viewDidLoad() {
        super.viewDidLoad()
        // è·å–å¹¶è®¾ç½®é¡µé¢æ•°æ®
        setPageData()
        // å¯åŠ¨å®šæ—¶å™¨
        loop()
    }
    
    // è·å–å¹¶è®¾ç½®æ•°æ®
    func setPageData(){
        // å‘èµ·postè¯·æ±‚
        Alamofire.request("https://www.xxx.com",method: .post,parameters: ["userName":"xxx","password":"xxx"],encoding: JSONEncoding.default).responseJSON { (response) in
            switch response.result {
            // è¯·æ±‚æˆåŠŸ
            case .success(let resData):
                // å°†è¿”å›çš„æ•°æ®è½¬ä¸ºJSONå¯¹è±¡
                let jsonData = JSON.init(resData as Any)
                // å˜é‡èµ‹å€¼
                self.electricityToday.stringValue = jsonData["data"]["electricityToday"].string!
                self.currentMonthBatteryTotal.stringValue = jsonData["data"]["currentMonthBatteryTotal"].string!
                self.remainingBattery.stringValue = jsonData["data"]["remainingBattery"].string!
                self.time.stringValue = jsonData["data"]["time"].string!
                break
            case .failure(let error):
                print("æ¥å£è°ƒç”¨å¤±è´¥")
                print(error);
                break
            }
        }
    }
    
    // GCD æ–¹å¼çš„å®šæ—¶å™¨ï¼Œå¾ªç¯
    func loop() {
        print("\(Date()): å®šæ—¶å™¨åˆå§‹åŒ–")
        // timeInterval: éš”å¤šå°‘ç§’æ‰§è¡Œä¸€æ¬¡
        timer = Timer(timeInterval: 1200, repeats: true, block: { timer in
            self.loopFireHandler(timer)
        })
        // æ·»åŠ å®šæ—¶å™¨
        RunLoop.main.add(timer!, forMode: .common)
    }
    // å®šæ—¶å™¨éœ€è¦æ‰§è¡Œçš„å†…å®¹
    @objc private func loopFireHandler(_ timer: Timer?) -> Void {
        // å®šæ—¶å™¨æ‰§è¡Œç»“æŸç»“æŸ
        if self.timeCount <= 0 {
            print("\(Date()): æ‰§è¡Œå®Œ1è½®ï¼Œå¼€å§‹ä¸‹ä¸€è½®")
            self.timeCount = 3
            return
        }
        // è·å–å¹¶è®¾ç½®é¡µé¢æ•°æ®
        setPageData()
        // æ‰§è¡Œå®Œåˆ†é’Ÿ
        self.timeCount -= 1
      
    }

}


extension PopoverViewController {
    static func freshController() -> PopoverViewController {
        //è·å–å¯¹Main.storyboardçš„å¼•ç”¨
        let storyboard = NSStoryboard(name: NSStoryboard.Name("Main"), bundle: nil)
        // ä¸ºPopoverViewControlleråˆ›å»ºä¸€ä¸ªæ ‡è¯†ç¬¦
        let identifier = NSStoryboard.SceneIdentifier("PopoverViewController")
        // å®ä¾‹åŒ–PopoverViewControllerå¹¶è¿”å›
        guard let viewcontroller = storyboard.instantiateController(withIdentifier: identifier) as? PopoverViewController else {
            fatalError("Something Wrong with Main.storyboard")
        }
        return viewcontroller
    }
}


```

## å†™åœ¨æœ€å
å¦‚ä½•çˆ¬å–ä½ æˆ¿é—´å†…ç”µè¡¨ä½¿ç”¨æƒ…å†µï¼Œè¯·ç§»æ­¥è¿™ç¯‡æ–‡ç« :[Javaçˆ¬å–ç”µè¡¨ç”µé‡ä½¿ç”¨æƒ…å†µ](https://juejin.im/post/5e75dcbde51d45271515811b)
